---
title: 'Update on the Facial Expression/Cortisol Project'
author: "Julianna Calabrese"
date: "Last updated 2/18/2019"
output:
  html_document:
    toc: true
    theme: united
    highlight: tango
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(mosaic)
library(ggplot2)
library(tidyr)
library(dplyr)
library(psych)
library(nlme)
library(plyr)
library(Hmisc)
library(rmarkdown)
library(yaml)
library(rapportools)
library(lavaan)
library(lme4)
library(corrr)
library(corrplot)
library(reshape2)
library(lmerTest)
library(multcomp)
library(optimx)
library(MuMIn)
library(Rmisc)
library(jsonlite)
library(knitr)
library(taRifx)
library(papeR)
library(stargazer)
library(kableExtra)
library(broom)
library(xtable)
library(sjPlot)
library(sjstats)
library(sjlabelled)
library(sjmisc)
library(ggeffects)
library(glmmTMB)
library(bindrcpp)
library(pbkrtest)
library(devtools)
library(psycholing)
library(pander)
library(coefplot)
library(ggiraphExtra)
library(languageR)
```

```{r Load in data, include=FALSE}
cp_long <- read.csv(file="C:/Users/jrcala/Documents/My Research/RStudio/cp_long.csv", header=TRUE, sep=",")
#cp_long <- read.csv(file="/Users/Julianna/Desktop/data/cp_long.csv", header=TRUE, sep=",")
cp_long$X <- NULL
cp_long$gender <- as.integer(cp_long$gender)
cp_long$gendercat <- as.character(cp_long$gendercat)
cp_long$male <- as.integer(cp_long$male)
cp_long$female <- as.integer(cp_long$female)
cp_long$genderold <- NULL
cp_long$baseline <- as.numeric(cp_long$cort_baseline_Win)
cp_long$baselineC <- as.numeric(cp_long$cort_baseline_WinC)
cp_long$cort_baseline_Win <- NULL
cp_long$cort_baseline_WinC <- NULL
cp_long$id <- as.factor(cp_long$id)
cp_long$timebeforepeak <- as.integer(cp_long$timebeforepeak)
cp_long$timeafterpeak <- as.integer(cp_long$timeafterpeak)
```

## Introduction

In this file, I do my best to follow the instructions as laid out in Lopez-Duran, Mayer, & Abelson 2014. I wil try to explain all the code written in this file, why I do it, and why things may look weird at times. I will also try to name objects, variables, and models as consistently as possible.

Since Lopez-Duran, Mayer, & Abelson's 2014 paper utilized the PROC MIXED command in SAS, this RMarkdown file will use the lme() command as part of the lme4 package. More information about nlme() can be found here: http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.130.1698&rep=rep1&type=pdf

## Model building

### Equation from Lopez-Duran 2014

$\begin{aligned}
Cortisol = \beta_0  
& + (\beta_1 \cdot Sex) \\
& + (\beta_2 \cdot TimeBeforePeak) \\
& + (\beta_3 \cdot TimeAfterPeak) \\
& + (\beta_4 \cdot Sex \cdot TimeBeforePeak) \\
& + (\beta_5 \cdot Sex \cdot TimeAfterPeak) \\
\end{aligned}$

### Definitions

* b0 = intercept aka peak
* b1 = the impact of sex on levels at the group peak time
* b2 = the activation slope for males
* b3 = the regulation slope for males
* b4 = the impact of sex (females) on the activation slope
* b5 = the impact of sex (females) on the regulation slope
* timebeforepeak = the reactivity slope / activation
* timeafterpeak = the recovery slope / regulation

The variable "gender" is a binary variable of 0 = male and 1 = female.

## Correlation Matrix

```{r results='asis', warning=FALSE, message=FALSE, echo=FALSE}
corr_vars <- data.frame(cp_long$angerC, cp_long$fearC, cp_long$happinessC, cp_long$sadnessC, cp_long$painC, cp_long$ctqsumC, cp_long$emosumC, cp_long$ThreatZSum, cp_long$DepZSum, cp_long$ThreatCompc, cp_long$DepCompc, cp_long$ThreatDepInt)

names(corr_vars) <- gsub(pattern = "cp_long._*", replacement = "", x = names(corr_vars))

corr_data <- stats::cor(corr_vars)

labels <- c("Anger", "Fear", "Happiness", "Sadness", "Pain", "CTQ Total", "CTQ Emotional", "ThreatZSum", "DepZSum", "ThreapCompc", "DepCompc", "ThreatDepInt")

sjp.corr(corr_data, corr.method=c("spearman"),title="Correlation Matrix", na.deletion = "pairwise", sort.corr=FALSE, show.values=TRUE, decimals=2, axis.labels = labels)

rm(corr_vars)
rm(corr_data)
rm(labels)
```

## Base Model

```{r}
lmer.base <- lmer(cortvalue ~ 
               1 # The 1 allows us to have a random/varying intercept for each subject
             + timebeforepeak # Fixed effect
             + timeafterpeak # Fixed effect
             + baseline # Fixed effect
             + (1|id) # Random effect intercepts for id, allows subjects to treated as independent
             + (0 + timebeforepeak|id) # Random effect of timebeforepeak within each level of id
             # the 0 + prohibits subjects to vary in terms of their intercept (aka their first
             # cortvalue value) and their effect of timebeforepeak
             + (0 + timeafterpeak|id), # Random effect of timeafterpeak within each level of id
             data=cp_long, REML=TRUE)
summary(lmer.base)
```

```{r}
base <- lme(cortvalue ~ 
              1 + # The 1 allows us to have a random/varying intercept for each subject
              timebeforepeak + # Fixed effect
              timeafterpeak + # Fixed effect
              baseline, # Fixed Effect
            random = ~ (timebeforepeak + timeafterpeak) - 1 | id, # Two random effects of
            # timebeforepeak and timeafterpeak within each level of id
            # but what does that "-1" do specifically?
            corr = corAR1(), #specifies AR1 structure
            data = cp_long)
summary(base) # Is there a reason that all the p-values are zero?
summary(base)$tTable[,]
```

I've been debating which R package to use to conduct mixed modeling, as it needs to be able to have multiple non-nested random effects and specify a correlation strucutre. It looks like I'm able to do this with nlme's lme command by doing 

> random = ~ timebeforepeak + timeafterpeak - 1 | id

But what does that "- 1" really do? If I don't include it, it doesn't work. I'll come back to this later.

## Emotion Models

### Anger

```{r}
anger <- lme(cortvalue ~ 
              1 + # The 1 allows us to have a random/varying intercept for each subject
              timebeforepeak + # Fixed effect
              timeafterpeak + # Fixed effect
              baseline + # Fixed Effect
               angerC + angerC*timebeforepeak + angerC*timeafterpeak,
            random = ~ (timebeforepeak + timeafterpeak) - 1 | id, # Two random effects of
            corr = corAR1(), #specifies AR1 structure
            data = cp_long)
summary(anger)
summary(anger)$tTable[,]
```

### Fear

```{r}
fear <- lme(cortvalue ~ 
              1 + # The 1 allows us to have a random/varying intercept for each subject
              timebeforepeak + # Fixed effect
              timeafterpeak + # Fixed effect
              baseline + # Fixed Effect
               fearC + fearC*timebeforepeak + fearC*timeafterpeak,
            random = ~ (timebeforepeak + timeafterpeak) - 1 | id, # Two random effects of
            # timebeforepeak and timeafterpeak within each level of id
            corr = corAR1(), #specifies AR1 structure
            data = cp_long)
summary(fear)
summary(fear)$tTable[,]
```

### Happiness

```{r}
happiness <- lme(cortvalue ~ 
              1 + # The 1 allows us to have a random/varying intercept for each subject
              timebeforepeak + # Fixed effect
              timeafterpeak + # Fixed effect
              baseline + # Fixed Effect
               happinessC + happinessC*timebeforepeak + happinessC*timeafterpeak,
            random = ~ (timebeforepeak + timeafterpeak) - 1 | id, # Two random effects of
            # timebeforepeak and timeafterpeak within each level of id
            corr = corAR1(), #specifies AR1 structure
            data = cp_long)
summary(happiness)
summary(happiness)$tTable[,]
```

### Sadness

```{r}
sadness <- lme(cortvalue ~ 
              1 + # The 1 allows us to have a random/varying intercept for each subject
              timebeforepeak + # Fixed effect
              timeafterpeak + # Fixed effect
              baseline + # Fixed Effect
               sadnessC + sadnessC*timebeforepeak + sadnessC*timeafterpeak,
            random = ~ (timebeforepeak + timeafterpeak) - 1 | id, # Two random effects of
            corr = corAR1(), #specifies AR1 structure
            data = cp_long)
summary(sadness)
summary(sadness)$tTable[,]
```

### Pain

```{r}
pain <- lme(cortvalue ~ 
              1 + # The 1 allows us to have a random/varying intercept for each subject
              timebeforepeak + # Fixed effect
              timeafterpeak + # Fixed effect
              baseline + # Fixed Effect
               painC + painC*timebeforepeak + painC*timeafterpeak,
            random = ~ (timebeforepeak + timeafterpeak) - 1 | id, # Two random effects of
            corr = corAR1(), #specifies AR1 structure
            data = cp_long)
summary(pain)
summary(pain)$tTable[,]
```

## Trauma Models

### CTQ Total Sum

```{r}
ctq <- lme(cortvalue ~ 
              1 + # The 1 allows us to have a random/varying intercept for each subject
              timebeforepeak + # Fixed effect
              timeafterpeak + # Fixed effect
              baseline + # Fixed Effect
               ctqsumC + ctqsumC*timebeforepeak + ctqsumC*timeafterpeak,
            random = ~ (timebeforepeak + timeafterpeak) - 1 | id, # Two random effects of
            corr = corAR1(), #specifies AR1 structure
            data = cp_long)
summary(ctq)
summary(ctq)$tTable[,]
```

### ThreatZSum

```{r}
ThreatZSum <- lme(cortvalue ~ 
              1 + # The 1 allows us to have a random/varying intercept for each subject
              timebeforepeak + # Fixed effect
              timeafterpeak + # Fixed effect
              baseline + # Fixed Effect
               ThreatZSum + ThreatZSum*timebeforepeak + ThreatZSum*timeafterpeak,
            random = ~ (timebeforepeak + timeafterpeak) - 1 | id, # Two random effects of
            corr = corAR1(), #specifies AR1 structure
            data = cp_long)
summary(ThreatZSum)
summary(ThreatZSum)$tTable[,]
```

### ThreatComp

```{r}
ThreatComp <- lme(cortvalue ~ 
              1 + # The 1 allows us to have a random/varying intercept for each subject
              timebeforepeak + # Fixed effect
              timeafterpeak + # Fixed effect
              baseline + # Fixed Effect
               ThreatComp + ThreatComp*timebeforepeak + ThreatComp*timeafterpeak,
            random = ~ (timebeforepeak + timeafterpeak) - 1 | id, # Two random effects of
            corr = corAR1(), #specifies AR1 structure
            data = cp_long)
summary(ThreatComp)
summary(ThreatComp)$tTable[,]
```

### DepZSum

```{r}
DepZSum <- lme(cortvalue ~ 
              1 + # The 1 allows us to have a random/varying intercept for each subject
              timebeforepeak + # Fixed effect
              timeafterpeak + # Fixed effect
              baseline + # Fixed Effect
               DepZSum + DepZSum*timebeforepeak + DepZSum*timeafterpeak,
            random = ~ (timebeforepeak + timeafterpeak) - 1 | id, # Two random effects of
            corr = corAR1(), #specifies AR1 structure
            data = cp_long)
summary(DepZSum)
summary(DepZSum)$tTable[,]
```

### DepComp

```{r}
DepComp <- lme(cortvalue ~ 
              1 + # The 1 allows us to have a random/varying intercept for each subject
              timebeforepeak + # Fixed effect
              timeafterpeak + # Fixed effect
              baseline + # Fixed Effect
               DepComp + DepComp*timebeforepeak + DepComp*timeafterpeak,
            random = ~ (timebeforepeak + timeafterpeak) - 1 | id, # Two random effects of
            corr = corAR1(), #specifies AR1 structure
            data = cp_long)
summary(DepComp)
summary(DepComp)$tTable[,]
```

### ThreatCompc

```{r}
ThreatCompc <- lme(cortvalue ~ 
              1 + # The 1 allows us to have a random/varying intercept for each subject
              timebeforepeak + # Fixed effect
              timeafterpeak + # Fixed effect
              baseline + # Fixed Effect
               ThreatCompc + ThreatCompc*timebeforepeak + ThreatCompc*timeafterpeak,
            random = ~ (timebeforepeak + timeafterpeak) - 1 | id, # Two random effects of
            corr = corAR1(), #specifies AR1 structure
            data = cp_long)
summary(ThreatCompc)
summary(ThreatCompc)$tTable[,]
```

### DepCompc

```{r}
DepCompc <- lme(cortvalue ~ 
              1 + # The 1 allows us to have a random/varying intercept for each subject
              timebeforepeak + # Fixed effect
              timeafterpeak + # Fixed effect
              baseline + # Fixed Effect
               DepCompc + DepCompc*timebeforepeak + DepCompc*timeafterpeak,
            random = ~ (timebeforepeak + timeafterpeak) - 1 | id, # Two random effects of
            corr = corAR1(), #specifies AR1 structure
            data = cp_long)
summary(DepCompc)
summary(DepCompc)$tTable[,]
```

### ThreatDepInt

```{r}
ThreatDepInt <- lme(cortvalue ~ 
              1 + # The 1 allows us to have a random/varying intercept for each subject
              timebeforepeak + # Fixed effect
              timeafterpeak + # Fixed effect
              baseline + # Fixed Effect
               ThreatDepInt + ThreatDepInt*timebeforepeak + ThreatDepInt*timeafterpeak,
            random = ~ (timebeforepeak + timeafterpeak) - 1 | id, # Two random effects of
            corr = corAR1(), #specifies AR1 structure
            data = cp_long)
summary(ThreatDepInt)
summary(ThreatDepInt)$tTable[,]
```
