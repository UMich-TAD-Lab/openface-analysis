---
title: "OpenFaceAim2a: The Semi-Successful Version"
author: "Julianna Calabrese"
date: "12/12/2018"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
#install.packages("mosaic")
#install.packages("ggplot2")
#install.packages("tidyr")
#install.packages("dplyr")
#install.packages("psych")
#install.packages("nlme")
#install.packages("plyr")
#install.packages("Hmisc")
#install.packages("rmarkdown")
#install.packages("shiny")
#install.packages("yaml")
#install.packages("rapportools")
#install.packages("lavaan")
#install.packages("lme4")
#install.packages("corrr")
#install.packages("corrplot")
#install.packages("reshape2")
#install.packages("lmerTest")
#install.packages("multcomp")
#install.packages("optimx")
#install.packages("MuMIn")

library(mosaic)
library(ggplot2)
library(tidyr)
library(dplyr)
library(psych)
library(nlme)
library(plyr)
library(Hmisc)
library(rmarkdown)
library(shiny)
library(yaml)
library(rapportools)
library(lavaan)
library(lme4)
library(corrr)
library(corrplot)
library(reshape2)
library(lmerTest)
library(multcomp)
library(optimx)
library(MuMIn)
```

### Outline/Description

This file will be where all the primary data analysis occurs. In previous rmd files, you'll need to convert all the stuff to a long format.

Then, you're going to run a model that looks like this...

mod1 <- lm(cortisol~time+time^2+sex+AU1+AU1*time+AU1*time*time^2)

...but it's not going to be a lm() model, it's going to be a multilevel growth curve model, so you'll probably need to use the lme4() package with the lmer() command or the nlme() package with the lme() command. This will produce a fixed effects table that represents the parameters of everything that you put in the above model to predict cortisol. Then you need to tell R what your random effects are, which is the intercept and time. 

Then you do something with landmark registration, but that's kind of already done, so you need to ask someone who ask access to that dataset to share it with you.

All the instructions can be found in Lopez-Duran 2014. Do NOT do anything involving AUC!

## Load in data and other logistics

```{r}
cp_long <- read.csv(file="C:/Users/jrcala/Documents/My Research/RStudio/cp_long.csv", header=TRUE, sep=",")
#cp_long <- read.csv(file="/Users/Julianna/Desktop/data/cp_long.csv", header=TRUE, sep=",")
cp_long$X <- NULL
```

## Correlation Matrix of relevant variables

```{r}
matrix_vars <- cp_long[c("cortvalue","stimeC","timenumC","painC", "angerC", "fearC", "happinessC", "sadnessC", "gender","ctqsumC")]

matrix_vars <- data.matrix(matrix_vars)

matrix1 <- cor(matrix_vars, use = "complete.obs")

col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))

corrplot(matrix1, method = "color", col = col(200),
         type = "upper", order = "hclust", number.cex = .7,
         addCoef.col = "black", # Add coefficient of correlation
         tl.col = "black", tl.srt = 90, # Text label color and rotation
         # Combine with significance
         #sig.level = 0.05, insig = "blank", 
         # hide correlation coefficient on the principal diagonal (or not)
         diag = TRUE, title = "Correlation Matrix", mar=c(0,0,3,0))
```

## Aim 2a

Cortisol = b0 + (b1 x sex) + (B2 x timebeforepeak) + (b3 x timeafterpeak) + (b4 x sex x timebeforepeak) + (b5 x sex x timeafterpeak)

```{r}
#b0 <- intercept aka peak
#b1 <- the impact of sex on levels at the group peak time
#b2 <- the activation slope for males
#b3 <- the regulation slope for males
#b4 <- the impact of sex (females) on the activation slope
#b5 <- the impact of sex (females) on the regulation slope
```

timebeforepeak = the reactivity slope / activation
timeafterpeak = the recovery slope / regulation

```{r Base Growth Curve Model}
cp_long$b0 <- cp_long$peaknamenum

test1 <- lm(peaknamenum ~ as.factor(gender), data = cp_long)
summary(test1)
cp_long$b1 <- -0.4046

cp_long$b2 <- ifelse((cp_long$gender == '0'), cp_long$timebeforepeak, 0)

cp_long$b3 <- ifelse((cp_long$gender == '0'), cp_long$timeafterpeak, 0)

test2 <- lm(timebeforepeak ~ as.factor(female), data=cp_long)
summary(test2)
cp_long$b4 <- 0.03717

test3 <- lm(timeafterpeak ~ as.factor(female), data=cp_long)
summary(test3)
cp_long$b5 <- 0.02191

lopez <- lmer(cortvalue ~ (1|b0) + (1|peaknamenum) + (b1*gender) + (b2*timebeforepeak) + (b3*timeafterpeak) + (b4*gender*timebeforepeak) + (b5*gender*timeafterpeak), data=cp_long, REML=TRUE)
summary(lopez)
```

```{r}
class(cp_long$peaknamenum)
class(cp_long$b0)
class(cp_long$b1)
class(cp_long$b2)
class(cp_long$b3)
class(cp_long$b4)
class(cp_long$b5)

#Everything is numeric except b0 and peaknamenum, which are integers, but I think this is okay.
```

```{r}
rm(test1)
rm(test2)
rm(test3)
```

## Adding emotions in the model that worked

```{r}
painlopez <- lmer(cortvalue ~ (1|b0) + (1|peaknamenum) + (b1*gender) + (b2*timebeforepeak) + (b3*timeafterpeak) + (b4*gender*timebeforepeak) + (b5*gender*timeafterpeak) + painC, data=cp_long, REML=TRUE)
summary(painlopez)
#Not sig!
```

```{r}
angrylopez <- lmer(cortvalue ~ (1|b0) + (1|peaknamenum) + (b1*gender) + (b2*timebeforepeak) + (b3*timeafterpeak) + (b4*gender*timebeforepeak) + (b5*gender*timeafterpeak) + angerC, data=cp_long, REML=TRUE)
summary(angrylopez)
#Not sig!
```

```{r}
fearfullopez <- lmer(cortvalue ~ (1|b0) + (1|peaknamenum) + (b1*gender) + (b2*timebeforepeak) + (b3*timeafterpeak) + (b4*gender*timebeforepeak) + (b5*gender*timeafterpeak) + fearC, data=cp_long, REML=TRUE)
summary(fearfullopez)
#Not sig!
```

```{r}
happylopez <- lmer(cortvalue ~ (1|b0) + (1|peaknamenum) + (b1*gender) + (b2*timebeforepeak) + (b3*timeafterpeak) + (b4*gender*timebeforepeak) + (b5*gender*timeafterpeak) + happinessC, data=cp_long, REML=TRUE)
summary(happylopez)
#Not sig!
#VERY WEIRD WARNING...
```

```{r}
sadlopez <- lmer(cortvalue ~ (1|b0) + (1|peaknamenum) + (b1*gender) + (b2*timebeforepeak) + (b3*timeafterpeak) + (b4*gender*timebeforepeak) + (b5*gender*timeafterpeak) + sadnessC, data=cp_long, REML=TRUE)
summary(sadlopez)
#SadnessC is the only significant model which is good!
```

## Running with sadness and adding more stuff

```{r}
ctqlopez <- lmer(cortvalue ~ (1|b0) + (1|peaknamenum) + (b1*gender) + (b2*timebeforepeak) + (b3*timeafterpeak) + (b4*gender*timebeforepeak) + (b5*gender*timeafterpeak) + ctqsum, data=cp_long, REML=TRUE)
summary(ctqlopez)
#CTQ isn't significant in this model
```

```{r}
sadctqlopez <- lmer(cortvalue ~ (1|b0) + (1|peaknamenum) + (b1*gender) + (b2*timebeforepeak) + (b3*timeafterpeak) + (b4*gender*timebeforepeak) + (b5*gender*timeafterpeak) + sadnessC + ctqsum, data=cp_long, REML=TRUE)
summary(sadctqlopez)
#CTQ still not sig, but SadnessC still is!
```

```{r}
cor(cp_long$sadnessC,cp_long$b0) #0.002
cor(cp_long$sadnessC,cp_long$b1) #NA
cor(cp_long$sadnessC,cp_long$b2) #0.02
cor(cp_long$sadnessC,cp_long$b3) #-0.015
cor(cp_long$sadnessC,cp_long$b4) #NA
cor(cp_long$sadnessC,cp_long$b5) #NA
```

```{r}
anova(lopez, sadlopez, sadctqlopez) #I think this says that the addition of sadness makes the model really good, right? 
```

## Still trying to recreate plots from Lopez-Duran et al. 2014

```{r}
ggplot(cp_long, aes(peaknamenum, cortvalue, shape=gendercat)) +
stat_summary(fun.y=mean, geom="line", size=1) +
stat_summary(fun.data=mean_se, geom="pointrange", size=1)  + ggtitle ("Trying desperately to plot peaknamenum")
```

```{r}
ggplot(cp_long, aes(as.integer(peaknamenum), sadnessC, shape=gendercat)) +
stat_summary(fun.y=mean, geom="line", size=1) +
stat_summary(fun.data=mean_se, geom="pointrange", size=1) + ggtitle ("Trying desperately to plot peaknamenum")
```

```{r}
cor(cp_long$peaknamenum,cp_long$sadnessC) #0.003
```

## Trying out the lopez models but with sample- variables

```{r Base GC Model with Sample Data}
cp_long$b0 <- cp_long$samplepeaknamenum

test1 <- lm(samplepeaknamenum ~ gendercat, data = cp_long)
summary(test1)
cp_long$b1 <- 2.6990

cp_long$b2 <- ifelse((cp_long$gendercat == 'male'), cp_long$sampletimebeforepeak, 0)

cp_long$b3 <- ifelse((cp_long$gendercat == 'male'), cp_long$sampletimeafterpeak, 0)

test2 <- lm(sampletimebeforepeak ~ as.factor(female), data=cp_long)
summary(test2)
cp_long$b4 <-  1.9808

test3 <- lm(sampletimeafterpeak ~ as.factor(female), data=cp_long)
summary(test3)
cp_long$b5 <- 0.7182

samplelopez <- lmer(cortvalueC ~ (1|b0) + (1|samplepeaknamenum) + (b1*gendercat) + (b2*sampletimebeforepeak) + (b3*sampletimeafterpeak) + (b4*gendercat*sampletimebeforepeak) + (b5*gendercat*sampletimeafterpeak), data=cp_long, REML=TRUE)
summary(samplelopez)

samplesadlopez <- lmer(cortvalueC ~ (1|b0) + (1|samplepeaknamenum) + (b1*gendercat) + (b2*sampletimebeforepeak) + (b3*sampletimeafterpeak) + (b4*gendercat*sampletimebeforepeak) + (b5*gendercat*sampletimeafterpeak) + sadnessC, data=cp_long, REML=TRUE)
summary(samplesadlopez)

samplesadctqlopez <- lmer(cortvalueC ~ (1|b0) + (1|samplepeaknamenum) + (b1*gendercat) + (b2*sampletimebeforepeak) + (b3*sampletimeafterpeak) + (b4*gendercat*sampletimebeforepeak) + (b5*gendercat*sampletimeafterpeak) + sadnessC + ctqsumC, data=cp_long, REML=TRUE)
summary(samplesadlopez)

anova(samplelopez, samplesadlopez, samplesadctqlopez)
rm(test1)
rm(test2)
rm(test3)
```

```{r}
ggplot(cp_long, aes(samplepeaknamenum, sadnessC, color=gendercat)) +
stat_summary(fun.data=mean_se, geom="pointrange") +
stat_summary(aes(y=fitted(samplesadlopez), linetype=gendercat),
fun.y=mean, geom="line")
```

```{r Without Sadness}
ggplot(cp_long, aes(samplepeaknamenum, cortvalueC, color=gendercat)) +
stat_summary(fun.data=mean_se, geom="pointrange") +
stat_summary(aes(y=fitted(samplelopez)),
fun.y=mean, geom="line")
```

```{r With Sadness}
ggplot(cp_long, aes(samplepeaknamenum, cortvalueC, color=gendercat)) +
stat_summary(fun.data=mean_se, geom="pointrange") +
stat_summary(aes(y=fitted(samplesadlopez)),
fun.y=mean, geom="line")
```

```{r Without Sadness}
ggplot(cp_long, aes(samplepeaknamenum, cortvalueC,
shape=gendercat, linetype=gendercat)) +
stat_summary(fun.y=mean, geom="point") +
stat_summary(fun.data=mean_se, geom="errorbar",
linetype="solid", width=0.6) +
stat_summary(aes(y=fitted(samplelopez)), fun.y=mean, geom="line") +
scale_shape_manual(values=c(1, 2)) +
labs(x="Sample Time", y="Centered Cortisol Values",
linetype="Gender", shape="Gender") +
theme_bw(base_size=10) +
theme(legend.justification=c(0,1), legend.position=c(0,1),
legend.background=
element_rect(fill="white", color="black"))
```

```{r With Sadness}
ggplot(cp_long, aes(samplepeaknamenum, cortvalueC,
shape=gendercat, linetype=gendercat)) +
stat_summary(fun.y=mean, geom="point") +
stat_summary(fun.data=mean_se, geom="errorbar",
linetype="solid", width=0.6) +
stat_summary(aes(y=fitted(samplesadlopez)), fun.y=mean, geom="line") +
scale_shape_manual(values=c(1, 2)) +
labs(x="Sample Time", y="Centered Cortisol Values",
linetype="Gender", shape="Gender") +
theme_bw(base_size=10) +
theme(legend.justification=c(0,1), legend.position=c(0,1),
legend.background=
element_rect(fill="white", color="black"))
```

## Creating that good model but without any warnings

```{r}
cp_long$b0 <- cp_long$samplepeaknamenum

test1 <- lm(samplepeaknamenum ~ gendercat, data = cp_long)
summary(test1)
cp_long$b1 <- 2.6990

cp_long$b2 <- ifelse((cp_long$gendercat == 'male'), cp_long$sampletimebeforepeak, 0)

cp_long$b3 <- ifelse((cp_long$gendercat == 'male'), cp_long$sampletimeafterpeak, 0)

test2 <- lm(sampletimebeforepeak ~ as.factor(female), data=cp_long)
summary(test2)
cp_long$b4 <-  1.9808

test3 <- lm(sampletimeafterpeak ~ as.factor(female), data=cp_long)
summary(test3)
cp_long$b5 <- 0.7182

samplelopez2 <- lmer(cortvalueC ~ (1|b0) + (1|samplepeaknamenum) + (b1*gendercat) + (b2*sampletimebeforepeak) + (b3*sampletimeafterpeak) + (b4*gendercat*sampletimebeforepeak) + (b5*gendercat*sampletimeafterpeak), data=cp_long, REML=TRUE, control = lmerControl(optimizer ='optimx', optCtrl=list(method='L-BFGS-B')))
summary(samplelopez2)

samplesadlopez2 <- lmer(cortvalueC ~ (1|b0) + (1|samplepeaknamenum) + (b1*gendercat) + (b2*sampletimebeforepeak) + (b3*sampletimeafterpeak) + (b4*gendercat*sampletimebeforepeak) + (b5*gendercat*sampletimeafterpeak) + sadnessC, data=cp_long, REML=TRUE, control = lmerControl(optimizer ='optimx', optCtrl=list(method='L-BFGS-B')))
summary(samplesadlopez2)

samplesadctqlopez2 <- lmer(cortvalueC ~ (1|b0) + (1|samplepeaknamenum) + (b1*gendercat) + (b2*sampletimebeforepeak) + (b3*sampletimeafterpeak) + (b4*gendercat*sampletimebeforepeak) + (b5*gendercat*sampletimeafterpeak) + sadnessC + ctqsumC, data=cp_long, REML=TRUE, control = lmerControl(optimizer ='optimx', optCtrl=list(method='L-BFGS-B')))
summary(samplesadlopez2)

anova(samplelopez2, samplesadlopez2, samplesadctqlopez2)
rm(test1)
rm(test2)
rm(test3)
```

#### Finding other important info?

```{r}
#Or at least trying to...

r.squaredGLMM(samplelopez2)
r.squaredGLMM(samplesadlopez2)

#AIC and BIC are useless when REML is involved, but why not?
AIC(samplelopez2)
BIC(samplelopez2)
AIC(samplesadlopez2)
BIC(samplesadlopez2)
```

## ggplot with the new fewer-warning sample models

```{r Without Sadness}
ggplot(cp_long, aes(samplepeaknamenum, cortvalueC, color=gendercat)) +
stat_summary(fun.data=mean_se, geom="pointrange") +
stat_summary(aes(y=fitted(samplelopez2)),
fun.y=mean, geom="line")
```

```{r With Sadness}
ggplot(cp_long, aes(samplepeaknamenum, cortvalueC, color=gendercat)) +
stat_summary(fun.data=mean_se, geom="pointrange") +
stat_summary(aes(y=fitted(samplesadlopez2)),
fun.y=mean, geom="line")
```

```{r Without Sadness Edited}
timeticks <- c(0, 3, 15, 25, 30, 35, 40, 45, 60)

ggplot(cp_long, aes(samplepeaknamenum, cortvalueC, color=gendercat, shape=gendercat)) +
stat_summary(fun.y=mean, geom="point", size=5) +
stat_summary(fun.data=mean_se, geom="errorbar",
linetype="solid", width=0.6) +
stat_summary(aes(y=fitted(samplelopez2)), fun.y=mean, geom="line", lwd=1.5) +
scale_shape_manual(values=c(16, 17)) +
labs(x="Sample Time", y="Centered Cortisol Values",
color="Gender", shape="Gender") +
theme_bw(base_size=18) +
theme(legend.justification=c(0,1), legend.position=c(0,1),
legend.background=
element_rect(fill="white", color="black")) + scale_x_continuous(breaks=timeticks) + ggtitle("Base Model")
```

```{r With Sadness Edited}
timeticks <- c(0, 3, 15, 25, 30, 35, 40, 45, 60)

ggplot(cp_long, aes(samplepeaknamenum, cortvalueC, color=gendercat, shape=gendercat)) +
stat_summary(fun.y=mean, geom="point", size=5) +
stat_summary(fun.data=mean_se, geom="errorbar",
linetype="solid", width=0.6) +
stat_summary(aes(y=fitted(samplesadlopez2)), fun.y=mean, geom="line", lwd=1.5) +
scale_shape_manual(values=c(16, 17)) +
labs(x="Sample Time", y="Centered Cortisol Values",
color="Gender", shape="Gender") +
theme_bw(base_size=18) +
theme(legend.justification=c(0,1), legend.position=c(0,1),
legend.background=
element_rect(fill="white", color="black")) + scale_x_continuous(breaks=timeticks) + ggtitle("Sad Model")
```

## Writing out the new cp_long

```{r}
#write.csv(cp_long, file="/Users/Julianna/Desktop/data/cp_long_aim2a.csv")
#write.csv(cp_long, file="C:/Users/jrcala/Documents/My Research/RStudio/cp_long_aim2a.csv")
```
