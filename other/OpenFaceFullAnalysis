---
title: "Another attempt at an explanation"
author: "Julianna Calabrese"
date: "Last knitted: `r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    collapse: subsection
    theme: united
    highlight: tango
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r library, include=FALSE}
library(car)
library(MASS)
library(tidyverse)
library(psych)
library(stats)
library(summarytools)
library(kableExtra)
library(nlme)
library(lme4)
library(sjPlot)
library(sjstats)
library(multcomp)
library(lattice)
library(rlang)
library(lmerTest) # Gives you p-values for lmer models
```

```{r Load in and lightly clean data, include=FALSE}
data <- read.csv(file="C:/Users/jrcala/Documents/My Research/RStudio/for_full_cort_analysis.csv", header=TRUE, sep=",", stringsAsFactors = FALSE)
#data <- read.csv(file="/Users/Julianna/Desktop/data/for_full_cort_analysis.csv", header=TRUE, sep=",")
data$X <- NULL
#data$genderold <- NULL
data$baseline <- as.numeric(data$cort_baseline_Win)
data$cort_baseline_Win <- NULL
data$ThreatCompc <- data$ThreatComp - mean(data$ThreatComp)
data$DepCompc <- data$DepComp - mean(data$DepComp)
data$ThreatDepInt <- data$ThreatCompc*data$DepCompc
```

## Cheatsheets

* [SAS reference](https://support.sas.com/documentation/cdl/en/statug/63962/HTML/default/viewer.htm#mixed_toc.htm)
* [lme4 cheatsheet](https://stats.stackexchange.com/questions/13166/rs-lmer-cheat-sheet)
* [nlme cheatsheet](https://bartomeuslab.com/tag/nlme/)
* [Mixed model reference](https://www.cscu.cornell.edu/news/Handouts/R_Model_Specification.pdf)
* [Random intercept model](https://www.bristol.ac.uk/media-library/sites/cmm/migrated/documents/random-ints.pdf)

## Melissa's syntax for reference

```
PROC MIXED DATA=longdata COVTEST METHOD=REML;
	WHERE time > -1 and usable = 1; /*starting at sample 0, usable only*/
	CLASS ID ; /*Categorical variables*/
	MODEL Cortwinbox = Cort_baseline_winbox TimeBeforePeak2 TimeAfterPeak2
			 threatcomp_mc threatcomp_mc*Cort_baseline_winbox 
			 threatcomp_mc*TimeBeforePeak2 threatcomp_mc*TimeAfterPeak2
						/SOLUTION DDFM=BW;
	RANDOM intercept TimeBeforePeak2 TimeAfterPeak2/SUB=ID TYPE=ar(1) GCORR; 
	RUN; QUIT;
```

## R packages

While there are many R packages that can conduct mixed modeling, the two most popular choices are the [lme4 package](https://cran.r-project.org/web/packages/lme4/lme4.pdf) with the lmer command and the [nlme package](https://cran.r-project.org/web/packages/nlme/nlme.pdf) with the lme command. Both are suitable alternatives to SAS' PROC MIXED command: [lme4 here](https://cran.r-project.org/web/packages/SASmixed/vignettes/Usinglmer.pdf), [nlme here](http://www.solutionmetrics.com.au/support/splus82win/lmeSAS.pdf). 

The biggest difference between nlme and lme is that nlme allows you to specify a correlation structure (e.g. AR1), while lme4 automatically [defaults to unstructured and is unable to be changed.](https://stats.stackexchange.com/questions/86958/variance-covariance-structure-for-random-effects-in-lme4) However, it's 100x easier to specify non-nested random effects in lme4 than nlme, so if I used nlme, I could only have one random effect or I would have to nest one random effect within the other.

Other packages include [glmmTMB](https://cran.r-project.org/web/packages/glmmTMB/glmmTMB.pdf) and [brms](https://cran.r-project.org/web/packages/brms/brms.pdf). However, glmmTMB seems to offer nothing more than what nlme can offer and brms is used for Bayesian regression modelling, which wasn't used in Lopez-Duran 2014.

## Models

Below are two models that are as close as possible to Melissa's models in R. The first model is a random intercept model with an ar1 structure with the `nlme` package. The second model is a random slopes model with a default, unconstrained structure with the `lme4` package;

```{r, echo=TRUE, results = 'hide'}
# Random intercept with ar1 structure
mod1 <- lme(cortvalue ~
            timebeforepeak + # Fixed effect
            timeafterpeak + # Fixed effect
            baseline + # Fixed effect
            ThreatCompc + # Fixed effect
            ThreatCompc*timebeforepeak + # Interaction
            ThreatCompc*timeafterpeak + ThreatCompc*baseline, # Interaction
            random = ~1|id, # Random intercept for Subject
            corr = corAR1(), # Specifies AR1 structure
            method = "REML", # Specifies REML fit
            na.action = na.exclude, # removes NA values
            data = data)
```

```{summary mod1, include=FALSE, echo=FALSE}
summary(mod1)
```

```{r mod2, echo=TRUE, results = 'hide', warning=FALSE, message=FALSE}
# Random slopes with unconstrained structure
mod2 <- lmer(cortvalue ~ 
            timebeforepeak + # Fixed effect
            timeafterpeak + # Fixed effect
            baseline + # Fixed effect
            ThreatCompc + # Fixed effect
            ThreatCompc*timebeforepeak + # Interaction
            ThreatCompc*timeafterpeak + # Interaction
            ThreatCompc*baseline + # Interaction
            (timebeforepeak|id) + (timeafterpeak|id), # Random slopes
            # Default unconstrained cor structure
            data = data)
```

```{r summary mod2, include=FALSE}
options(scipen=99)
summary(mod2)
```

```{r Cleaning for tab_model, include=FALSE}
colorder <- c("est", "se", "p")

labels <- c("Intercept", "TimeBeforePeak", "TimeAfterPeak", "Baseline", "ThreatCompc", "ThreatCompc * TimeBeforePeak", "ThreatCompc * TimeAfterPeak", "ThreatCompc * Baseline")
```

```{r table, echo=FALSE, results = 'asis'}
tab_model(mod1, title = "nlme Model with a Random Intercept and a corAR1 structure",
          dv.labels = "Cortisol", pred.labels = labels, digits = 3, digits.p = 3,
          emph.p = TRUE,
          show.ci = FALSE, show.icc=FALSE, show.re.var=FALSE, show.aic=FALSE,
          show.std=NULL,
          show.df = TRUE, string.df="DF", p.val = "wald",
          show.stat = TRUE, string.stat = "T",          
          show.est = TRUE, # No string.est
          show.se = TRUE, string.se="Std Error",
          show.p = TRUE, string.p="P-value",
          show.r2 = TRUE,
          col.order=colorder)
```

$\begin{aligned}
Cortisol = \beta_0  
& + \beta_1 \cdot TimeBeforePeak \\
& + \beta_2 \cdot TimeAfterPeak \\
& + \beta_3 \cdot Baseline \\
& + \beta_4 \cdot ThreatCompc \\
& + \beta_5 \cdot ThreatCompc \cdot TimeBeforePeak \\
& + \beta_6 \cdot ThreatCompc \cdot TimeAfterPeak \\
& + \beta_7 \cdot ThreatCompc \cdot Baseline \\
& + \mu \cdot Subject \\
& + \epsilon \\
\end{aligned}$

```{r mod2 table, echo=FALSE, results = 'asis'}
tab_model(mod2, title = "lme4 Model with Random Slopes and a UN structure",
          dv.labels = "Cortisol", pred.labels = labels, digits = 3, digits.p = 3,
          show.ci = FALSE, show.icc=FALSE, show.re.var=FALSE, show.aic=FALSE,
          show.std = NULL,
          emph.p = TRUE,
          show.df = TRUE, string.df="DF", p.val = "wald",
          show.stat = TRUE, string.stat = "T",          
          show.est = TRUE, # No string.est
          show.se = TRUE, string.se="Std Error",
          show.p = TRUE, string.p="P-value",
          show.r2 = TRUE,
          col.order=colorder)
```

$\begin{aligned}
Cortisol = \beta_0  
& + \beta_1 \cdot TimeBeforePeak \\
& + \beta_2 \cdot TimeAfterPeak \\
& + \beta_3 \cdot Baseline \\
& + \beta_4 \cdot ThreatCompc \\
& + \beta_5 \cdot ThreatCompc \cdot TimeBeforePeak \\
& + \beta_6 \cdot ThreatCompc \cdot TimeAfterPeak \\
& + \beta_7 \cdot ThreatCompc \cdot Baseline \\
& + \mu \cdot TimeBeforePeak_{Subject} \\
& + \mu \cdot TimeAfterPeak_{Subject} \\
& + \epsilon \\
\end{aligned}$

I would say that there are no big differences between the models. The only difference is that the Intercept is not significant in mod2, which makes because mod2 doesn't allow the intercept to vary. I like mod1 better because I think having the ar1 structure is more important than having TimeBeforePeak and TimeAfterPeak as random effects.

```{r mod1 and mod2 table, include=FALSE, echo=FALSE, results = 'asis'}
tab_model(mod1, mod2, 
          title = "nlme model vs. lme4 model",
          dv.labels = c("nlme model", "lme4 model"), 
          pred.labels = labels, digits = 3, digits.p = 3,
          show.ci = FALSE, show.icc=FALSE, show.re.var=FALSE, show.aic=FALSE,
          show.std = NULL,
          emph.p = TRUE,
          show.df = TRUE, string.df="DF", p.val = "wald",
          show.stat = TRUE, string.stat = "T",          
          show.est = TRUE, # No string.est
          show.se = TRUE, string.se="Std Error",
          show.p = TRUE, string.p="P-value",
          show.r2 = TRUE,
          col.order=colorder)
```
