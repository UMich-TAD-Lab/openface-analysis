---
title: "Another attempt at an explanation"
author: "Julianna Calabrese"
date: "March 28, 2019"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    collapse: subsection
    theme: united
    highlight: tango
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r library, include=FALSE}
library(car)
library(MASS)
library(tidyverse)
library(psych)
library(stats)
library(summarytools)
library(kableExtra)
library(nlme)
library(lme4)
library(sjPlot)
library(sjstats)
library(lmerTest) # Gives you p-values for lmer models
```

```{r Load in and lightly clean data, include=FALSE}
data <- read.csv(file="C:/Users/jrcala/Documents/My Research/RStudio/for_full_cort_analysis.csv", header=TRUE, sep=",", stringsAsFactors = FALSE)
#data <- read.csv(file="/Users/Julianna/Desktop/data/for_full_cort_analysis.csv", header=TRUE, sep=",")
data$X <- NULL
data$genderold <- NULL
data$baseline <- as.numeric(data$cort_baseline_Win_thing)
data$cort_baseline_Win_thing <- NULL
data$ThreatCompc <- data$ThreatComp - mean(data$ThreatComp)
data$DepCompc <- data$DepComp - mean(data$DepComp)
data$ThreatDepInt <- data$ThreatCompc*data$DepCompc
```

## Melissa's syntax for reference

> PROC MIXED DATA=longdata COVTEST METHOD=REML;
	    > WHERE time > -1 and usable = 1; /*starting at sample 0, usable only*/
	    > CLASS ID ; /*Categorical variables*/
      >	MODEL Cortwinbox = Cort_baseline_winbox TimeBeforePeak2 TimeAfterPeak2 threatcomp_mc threatcomp_mc*Cort_baseline_winbox threatcomp_mc*TimeBeforePeak2 threatcomp_mc*TimeAfterPeak2
					>	/SOLUTION DDFM=BW;
	    > RANDOM intercept TimeBeforePeak2 TimeAfterPeak2/SUB=ID TYPE=ar(1) GCORR; 
	    > RUN; QUIT;
	
* SUBJECT= creates block-diagonality
* If something is mentioned in CLASS, it has to be mentioned in the model line

[Cool reference for SAS.](https://support.sas.com/documentation/cdl/en/statug/63962/HTML/default/viewer.htm#mixed_toc.htm)

## Differences between R packages

While there are many R packages that can conduct mixed modeling, the two most popular choices are the [lme4 package](https://cran.r-project.org/web/packages/lme4/lme4.pdf) with the lmer command and the [nlme package](https://cran.r-project.org/web/packages/nlme/nlme.pdf) with the lme command. Both are suitable alternatives to SAS' PROC MIXED command: [lme4 here](https://cran.r-project.org/web/packages/SASmixed/vignettes/Usinglmer.pdf), [nlme here](http://www.solutionmetrics.com.au/support/splus82win/lmeSAS.pdf). 

Ultimately, I decided to go with the nlme package. The main reason I went with nlme is because nlme allows me to specify a correlation structure (e.g. AR1), while lme4 automatically [defaults to unstructured and is unable to be changed.](https://stats.stackexchange.com/questions/86958/variance-covariance-structure-for-random-effects-in-lme4) It is important to note that both packages allow me to have multiple crossed random effects, something I originally thought was impossible with nlme.

Other packages include [glmmTMB](https://cran.r-project.org/web/packages/glmmTMB/glmmTMB.pdf) and [brms](https://cran.r-project.org/web/packages/brms/brms.pdf). However, glmmTMB seems to offer nothing more than what nlme can offer and brms is used for Bayesian regression modelling, which wasn't used in Lopez-Duran 2014.

## Multiple ways to specify multiple random effects in nlme

There are multiple ways to specify two or more random effects in nlme. This is easier done in lme4. It can also be done in nlme, but it is not intuitive. The random effects need to let the intercept and slope vary randomly. Below I list some examples of how to do this, where a and b are two crossed random effects.

[Here is a good reference guide for R model specifications, which includes sections on lme4 and nlme.](https://www.cscu.cornell.edu/news/Handouts/R_Model_Specification.pdf)

## Models

```{r echo=TRUE, results = 'hide'}
# Random intercept with ar1 structure
mod1 <- lme(cortvalue ~
            timebeforepeak + # Fixed effect
            timeafterpeak + # Fixed effect
            baseline + # Fixed effect
            ThreatCompc + # Fixed effect
            ThreatCompc*timebeforepeak + # Interaction
            ThreatCompc*timeafterpeak + ThreatCompc*baseline, # Interaction
            random = ~1|id, # Random intercept for Subject
            corr = corAR1(), # Specifies AR1 structure
            method = "REML", # Specifies REML fit
            na.action = na.exclude, # removes NA values
            data = data)
```

```{include=FALSE, echo=FALSE}
summary(mod1)
```

```{r echo=TRUE, results = 'hide', warning=FALSE, message=FALSE}
# Random slopes with unconstrained structure
mod2 <- lmer(cortvalue ~ 
            timebeforepeak + # Fixed effect
            timeafterpeak + # Fixed effect
            baseline + # Fixed effect
            ThreatCompc + # Fixed effect
            ThreatCompc*timebeforepeak + # Interaction
            ThreatCompc*timeafterpeak + # Interaction
            ThreatCompc*baseline + # Interaction
            (timebeforepeak|id) + (timeafterpeak|id), # Random slopes
            # Default unconstrained cor structure
            data = data)
```

```{r include=FALSE}
options(scipen=99)
summary(mod2)
```

```{r include=FALSE}
colorder <- c("est", "se", "p")

labels <- c("Intercept", "TimeBeforePeak", "TimeAfterPeak", "Baseline", "ThreatCompc", "ThreatCompc * TimeBeforePeak", "ThreatCompc * TimeAfterPeak", "ThreatCompc * Baseline")
```

```{r echo=FALSE}
tab_model(mod1, title = "nlme Model with a Random Intercept and a corAR1 structure",
          dv.labels = "Cortisol", pred.labels = labels, digits = 3, digits.p = 3,
          show.ci = FALSE, show.icc=FALSE, show.re.var=FALSE, show.aic=FALSE,
          show.std=NULL,
          show.df = TRUE, string.df="DF", p.val = "wald",
          show.stat = TRUE, string.stat = "T",          
          show.est = TRUE, # No string.est
          show.se = TRUE, string.se="Std Error",
          show.p = TRUE, string.p="P-value",
          show.r2 = TRUE,
          col.order=colorder)
```

$\begin{aligned}
Cortisol = \beta_0  
& + \beta_1 \cdot TimeBeforePeak \\
& + \beta_2 \cdot TimeAfterPeak \\
& + \beta_3 \cdot Baseline \\
& + \beta_4 \cdot ThreatCompc \\
& + \beta_5 \cdot ThreatCompc \cdot TimeBeforePeak \\
& + \beta_6 \cdot ThreatCompc \cdot TimeAfterPeak \\
& + \beta_7 \cdot ThreatCompc \cdot Baseline \\
& + \mu \cdot Subject \\
& + \epsilon \\
\end{aligned}$

```{r echo=FALSE}
tab_model(mod2, title = "lme4 Model with Random Slopes and a UN structure",
          dv.labels = "Cortisol", pred.labels = labels, digits = 3, digits.p = 3,
          show.ci = FALSE, show.icc=FALSE, show.re.var=FALSE, show.aic=FALSE,
          show.std = NULL,
          show.df = TRUE, string.df="DF", p.val = "wald",
          show.stat = TRUE, string.stat = "T",          
          show.est = TRUE, # No string.est
          show.se = TRUE, string.se="Std Error",
          show.p = TRUE, string.p="P-value",
          show.r2 = TRUE,
          col.order=colorder)
```



```{r echo=FALSE, include=FALSE}
dv <- c("nlme Model", "lme4 Model")
tab_model(mod1, mod2, 
          title = "nlme vs. lme4",
          dv.labels = dv, pred.labels = labels, digits = 3, digits.p = 3,
          show.ci = FALSE, show.icc=FALSE, show.re.var=FALSE, show.aic=FALSE,
          show.std = NULL,
          show.df = TRUE, string.df="DF", p.val = "wald",
          show.stat = TRUE, string.stat = "T",          
          show.est = TRUE, # No string.est
          show.se = TRUE, string.se="Std Error",
          show.p = TRUE, string.p="P-value",
          show.r2 = TRUE,
          col.order=colorder)
```


That's all. I like mod1 better; Intercept is significant there. I also think having the ar1 structure is important, more important than having TimeBeforePeak and TimeAfterPeak as random effects. Also I keep getting an error with `tab_model` on mod2. 

$\begin{aligned}
Cortisol = \beta_0  
& + \beta_1 \cdot TimeBeforePeak \\
& + \beta_2 \cdot TimeAfterPeak \\
& + \beta_3 \cdot Baseline \\
& + \beta_4 \cdot ThreatCompc \\
& + \beta_5 \cdot ThreatCompc \cdot TimeBeforePeak \\
& + \beta_6 \cdot ThreatCompc \cdot TimeAfterPeak \\
& + \beta_7 \cdot ThreatCompc \cdot Baseline \\
& + \mu \cdot Subject \\
& + \epsilon \\
\end{aligned}$

```{r, include=FALSE}
$\begin{aligned}
Cortisol = \beta_{Intercept} \\  
& + \beta_{TimeBeforePeak} \\
& + \beta_{TimeAfterPeak} \\
& + \beta_{Baseline} \\
& + \beta_{ThreatCompc} \\
& + \beta_{ThreatCompc \cdot TimeBeforePeak} \\
& + \beta_{ThreatCompc \cdot TimeAfterPeak} \\
& + \beta_{ThreatCompc \cdot Baseline} \\
& + \mu_{Subject} \\
& + \epsilon \\
\end{aligned}$
```

